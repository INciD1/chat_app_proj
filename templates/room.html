{% extends 'base.html' %} {% block content %}
<div class="message-box">
  <div class="room-header">
    <h2><i class="fas fa-comments"></i> ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó <span class="room-code">{{code}}</span></h2>
    <button type="button" id="change-name-btn" class="change-name-btn">
      <i class="fas fa-user-edit"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
    </button>
    
    <!-- ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) -->
    <div id="change-name-modal" class="change-name-modal">
      <div class="change-name-content">
        <h3>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <form action="/change_name" method="post">
          <div class="input-group">
            <label for="new_name">‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:</label>
            <input type="text" id="new_name" name="new_name" value="{{ session.get('name') }}" required>
          </div>
          <div class="change-name-buttons">
            <button type="button" id="cancel-change-name" class="cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="confirm-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="inputs">
    <div class="message-tools">
      <button type="button" id="emoji-btn" class="tool-btn"><i class="far fa-smile"></i></button>
      <button type="button" id="gif-btn" class="tool-btn"><i class="fas fa-image"></i></button>
      <div id="emoji-picker" class="emoji-picker">
        <!-- Emoji ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
      </div>
      <div id="gif-picker" class="gif-picker">
        <div class="gif-search">
          <input type="text" id="gif-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GIF...">
        </div>
        <div id="gif-results" class="gif-results">
          <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå GIF ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>
      </div>
    </div>
    <input
      type="text"
      placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
      name="message"
      id="message"
      autocomplete="off"
    />
    <button type="button" id="send-btn" onclick="sendMessage()">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>

<script type="text/javascript">
  var socketio = io({
    transports: ['polling', 'websocket']
  });

  const messages = document.getElementById("messages");
  const currentUser = "{{ session.get('name') }}";
  const GIPHY_API_KEY = "YOUR_GIPHY_API_KEY"; // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô environment variable ‡πÅ‡∏ï‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡πÜ

  // Common emojis array
  const commonEmojis = [
    "üòÄ", "üòÅ", "üòÇ", "ü§£", "üòÉ", "üòÑ", "üòÖ", "üòÜ", "üòâ", "üòä", 
    "üòã", "üòé", "üòç", "üòò", "ü•∞", "üòó", "üòô", "üòö", "üôÇ", "ü§ó",
    "ü§©", "ü§î", "ü§®", "üòê", "üòë", "üò∂", "üôÑ", "üòè", "üò£", "üò•",
    "üòÆ", "ü§ê", "üòØ", "üò™", "üò´", "üò¥", "üòå", "üòõ", "üòú", "üòù",
    "ü§§", "üòí", "üòì", "üòî", "üòï", "üôÉ", "ü§ë", "üò≤", "‚òπÔ∏è", "üôÅ",
    "üòñ", "üòû", "üòü", "üò§", "üò¢", "üò≠", "üò¶", "üòß", "üò®", "üò©",
    "ü§Ø", "üò¨", "üò∞", "üò±", "ü•µ", "ü•∂", "üò≥", "ü§™", "üòµ", "üò°",
    "üò†", "ü§¨", "üò∑", "ü§í", "ü§ï", "ü§¢", "ü§Æ", "ü§ß", "üòá", "ü•≥",
    "ü•¥", "ü•∫", "ü§†", "ü§°", "ü§•", "ü§´", "ü§≠", "üßê", "ü§ì", "üòà",
    "üëã", "üëå", "üëç", "üëé", "‚ù§Ô∏è", "üî•", "‚ú®", "üéâ", "üëè", "üôè"
  ];

  // Populate emoji picker
  const populateEmojiPicker = () => {
    const emojiPicker = document.getElementById("emoji-picker");
    emojiPicker.innerHTML = ""; // Clear existing emojis
    
    commonEmojis.forEach(emoji => {
      const emojiSpan = document.createElement("span");
      emojiSpan.textContent = emoji;
      emojiSpan.className = "emoji";
      emojiSpan.addEventListener("click", () => {
        const messageInput = document.getElementById("message");
        messageInput.value += emoji;
        messageInput.focus();
        toggleEmojiPicker(false);
      });
      
      emojiPicker.appendChild(emojiSpan);
    });
  };

  // Toggle emoji picker
  const toggleEmojiPicker = (show = undefined) => {
    const emojiPicker = document.getElementById("emoji-picker");
    const gifPicker = document.getElementById("gif-picker");
    
    if (show === undefined) {
      emojiPicker.classList.toggle("show");
    } else {
      emojiPicker.classList.toggle("show", show);
    }
    
    // Always hide GIF picker when toggling emoji picker
    gifPicker.classList.remove("show");
  };

  // Toggle GIF picker
  const toggleGifPicker = (show = undefined) => {
    const gifPicker = document.getElementById("gif-picker");
    const emojiPicker = document.getElementById("emoji-picker");
    
    if (show === undefined) {
      gifPicker.classList.toggle("show");
    } else {
      gifPicker.classList.toggle("show", show);
    }
    
    // Always hide emoji picker when toggling GIF picker
    emojiPicker.classList.remove("show");
    
    // Focus on search input when showing GIF picker
    if (gifPicker.classList.contains("show")) {
      document.getElementById("gif-search").focus();
    }
  };

  window.GIPHY_API_KEY = "sJghslgtT6djr7bYTPtF4jiz2PwhdYsm";; 
// Search for GIFs
  const searchGifs = (query) => {
    const resultsDiv = document.getElementById("gif-results");
    resultsDiv.innerHTML = '<div class="gif-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
  
    fetch(`https://api.giphy.com/v1/gifs/search?api_key=${window.GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=15&rating=g`)
      .then(response => response.json())
        .then(data => {
          resultsDiv.innerHTML = '';
        
          if (data.data.length === 0) {
            resultsDiv.innerHTML = '<div class="gif-no-results">‡πÑ‡∏°‡πà‡∏û‡∏ö GIF ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
            return;
          }
        
        data.data.forEach(gif => {
          const gifItem = document.createElement("div");
          gifItem.className = "gif-item";
          
          const img = document.createElement("img");
          img.src = gif.images.fixed_height_small.url;
          img.alt = gif.title;
          
          img.addEventListener("click", () => {
            sendGif(gif.images.fixed_height.url, gif.title);
            toggleGifPicker(false);
          });
          
          gifItem.appendChild(img);
          resultsDiv.appendChild(gifItem);
        });
      })
      .catch(error => {
        console.error("Error fetching GIFs:", error);
        resultsDiv.innerHTML = '<div class="gif-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GIF</div>';
      });
  };

  // Send GIF message
  const sendGif = (url, title) => {
    socketio.emit("message", { 
      data: `[gif:${url}]`, 
      isGif: true, 
      gifTitle: title 
    });
  };

  const createMessage = (name, msg, isSystem = false, isGif = false, gifTitle = "") => {
    if (isSystem) {
      const content = `
      <div class="system-message">
        <span>${name} ${msg}</span>
      </div>
      `;
      messages.innerHTML += content;
    } else if (isGif) {
      // Extract the GIF URL from message format [gif:URL]
      const gifUrl = msg.substring(5, msg.length - 1);
      const isCurrentUser = name === currentUser;
      const content = `
      <div class="text ${isCurrentUser ? 'sent' : ''}">
        <div class="message-content">
          <strong>${isCurrentUser ? '‡∏Ñ‡∏∏‡∏ì' : name}:</strong> 
          <div class="gif-container">
            <img src="${gifUrl}" alt="${gifTitle}" class="gif-message" />
          </div>
        </div>
        <span class="muted">
          ${new Date().toLocaleString()}
        </span>
      </div>
      `;
      messages.innerHTML += content;
    } else {
      // Process message to render emojis (not necessary, modern browsers render emojis automatically)
      const isCurrentUser = name === currentUser;
      const content = `
      <div class="text ${isCurrentUser ? 'sent' : ''}">
        <div class="message-content">
          <strong>${isCurrentUser ? '‡∏Ñ‡∏∏‡∏ì' : name}:</strong> ${msg}
        </div>
        <span class="muted">
          ${new Date().toLocaleString()}
        </span>
      </div>
      `;
      messages.innerHTML += content;
    }
    
    // Auto scroll to bottom
    messages.scrollTop = messages.scrollHeight;
  };

  socketio.on("message", (data) => {
    // Check if this is a system message (has entered/left the room)
    const isSystemMessage = data.message === "has entered the room" || data.message === "has left the room" || data.message.includes("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô");
    
    // Check if this is a GIF message
    const isGif = data.message && data.message.startsWith("[gif:") && data.message.endsWith("]");
    
    createMessage(data.name, data.message, isSystemMessage, isGif, data.gifTitle);
  });

  const sendMessage = () => {
    const message = document.getElementById("message");
    if (message.value == "") return;
    socketio.emit("message", { data: message.value });
    message.value = "";
  };
  
  // Event listeners
  document.addEventListener("DOMContentLoaded", function() {
    // Populate emoji picker
    populateEmojiPicker();
    
    // Emoji button click
    document.getElementById("emoji-btn").addEventListener("click", () => {
      toggleEmojiPicker();
    });
    
    // GIF button click
    document.getElementById("gif-btn").addEventListener("click", () => {
      toggleGifPicker();
    });
    
    // GIF search input
    document.getElementById("gif-search").addEventListener("keyup", function(event) {
      if (event.key === "Enter" && this.value.trim() !== "") {
        searchGifs(this.value.trim());
      }
    });
    
    // Close pickers when clicking outside
    document.addEventListener("click", function(event) {
      if (!event.target.closest("#emoji-picker") && !event.target.closest("#emoji-btn") &&
          !event.target.closest("#gif-picker") && !event.target.closest("#gif-btn")) {
        document.getElementById("emoji-picker").classList.remove("show");
        document.getElementById("gif-picker").classList.remove("show");
      }
    });
    
    // Add event listener for Enter key in message input
    document.getElementById("message").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
  const changeNameForm = document.querySelector("#change-name-modal form");
  changeNameForm.addEventListener("submit", function(event) {
    event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    
    const newName = document.getElementById("new_name").value.trim();
    const oldName = currentUser;
    
    if (newName) {
      // ‡πÉ‡∏ä‡πâ Fetch API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      fetch('/change_name', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `new_name=${encodeURIComponent(newName)}`
      })
      .then(response => {
        if (response.ok) {
          // ‡∏ã‡πà‡∏≠‡∏ô modal
          document.getElementById("change-name-modal").style.display = "none";
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
          window.currentUser = newName;
          
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á server ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ UI ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)
          createMessage("‡∏£‡∏∞‡∏ö‡∏ö", `${oldName} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô ${newName}`, true);
        } else {
          console.error("Error changing name");
        }
      })
      .catch(error => console.error('Error:', error));
    }
  });
});
</script>

{% for msg in messages %}
<script type="text/javascript">
  // Check if this is a system message
  const isSystemMsg = "{{msg.message}}" === "has entered the room" || 
                      "{{msg.message}}" === "has left the room" || 
                      "{{msg.message}}".includes("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô");
  
  // Check if this is a GIF message
  const isGifMsg = "{{msg.message}}".startsWith("[gif:") && "{{msg.message}}".endsWith("]");
  
  const msgName = "{{msg.name}}";
  const msgContent = "{{msg.message}}";
  const gifTitle = "{{msg.gifTitle|default('')}}";
  
  createMessage(msgName, msgContent, isSystemMsg, isGifMsg, gifTitle);
</script>
{% endfor %}
{% endblock %}